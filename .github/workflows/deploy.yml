name: Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script_stop: true
          script: |
            set -e
            echo "ğŸš€ Starting deployment..."
            
            echo "ğŸ” Environment check:"
            echo "   User: $(whoami)"
            echo "   Home: $HOME"
            echo "   PWD: $(pwd)"
            echo "   PATH: $PATH"
            
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"
            if [ -z "$DEPLOY_PATH" ]; then 
              echo "âŒ DEPLOY_PATH secret is required"
              exit 1
            fi
            
            echo "ğŸ“ Deploy path: $DEPLOY_PATH"
            echo "ğŸ” Checking if directory exists..."
            ls -la "$(dirname "$DEPLOY_PATH")" || echo "âš ï¸ Cannot list parent directory"
            
            echo "ğŸ“‚ Creating deploy directory..."
            mkdir -p "$DEPLOY_PATH" || {
              echo "âŒ Failed to create directory $DEPLOY_PATH"
              echo "ğŸ” Current user: $(whoami)"
              echo "ğŸ” Current directory: $(pwd)"
              echo "ğŸ” Disk space: $(df -h .)"
              exit 1
            }
            
            echo "âœ… Directory created/verified"
            ls -la "$DEPLOY_PATH" || echo "âš ï¸ Cannot list deploy directory"
            
            if [ ! -d "$DEPLOY_PATH/.git" ]; then
              echo "ğŸ“¥ Cloning repository..."
              git clone --depth=1 https://github.com/${{ github.repository }} "$DEPLOY_PATH" || {
                echo "âŒ Git clone failed"
                exit 1
              }
            else
              echo "ğŸ”„ Updating existing repository..."
              echo "ğŸ” Current git status before update:"
              cd "$DEPLOY_PATH" || {
                echo "âŒ Cannot cd to $DEPLOY_PATH"
                exit 1
              }
              echo "ğŸ“ In deploy directory: $(pwd)"
              git status || echo "âš ï¸ Git status failed"
              git remote -v || echo "âš ï¸ Git remote failed"
              
              echo "ğŸ“¥ Fetching latest changes..."
              git fetch origin main --depth=1 || {
                echo "âŒ Git fetch failed"
                echo "ğŸ” Git error details:"
                git status || true
                exit 1
              }
              
              echo "ğŸ”„ Resetting to latest main..."
              git reset --hard origin/main || {
                echo "âŒ Git reset failed"
                echo "ğŸ” Git error details:"
                git status || true
                exit 1
              }
              
              echo "âœ… Git update completed"
            fi
            
            cd "$DEPLOY_PATH" || {
              echo "âŒ Cannot cd to $DEPLOY_PATH after git operations"
              exit 1
            }
            
            echo "ğŸ“ Current directory: $(pwd)"
            echo "ğŸ“‹ Git status:"
            git log --oneline -3 || echo "âš ï¸ Git log failed"
            git status || echo "âš ï¸ Git status failed"
            
            # Ensure env file exists (copy once from example if missing)
            if [ ! -f .env ]; then 
              echo "ğŸ“ Creating .env from example..."
              cp env.example .env || echo "âš ï¸ Warning: could not copy env.example"
            fi
            
            echo "ğŸ³ Checking Docker..."
            docker --version || echo "âŒ Docker not available"
            docker compose version || echo "âŒ Docker Compose not available"
            
            echo "ğŸ”§ Building and starting services..."
            # Stop existing services first
            docker compose -f docker-compose.prod.yml down || echo "âš ï¸ No existing services to stop"
            
            # Build and start
            docker compose -f docker-compose.prod.yml up -d --build || {
              echo "âŒ Docker Compose failed. Checking logs..."
              docker compose -f docker-compose.prod.yml logs || true
              exit 1
            }
            
            echo "ğŸ§¹ Cleaning up Docker..."
            docker system prune -f || true
            
            echo "âœ… Deployment completed successfully!"
            echo "ğŸ“Š Service status:"
            docker compose -f docker-compose.prod.yml ps || true

